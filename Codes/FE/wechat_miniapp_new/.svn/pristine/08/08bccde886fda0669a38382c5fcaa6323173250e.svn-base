// pages/user-customer/user-customer.js
const activityService = require('../../services/activity-service.js');

Page({

  /**
   * 页面的初始数据
   */
  data: {
    customerActionList: ['最新时间', '营销力'], //线索切换
    customerActionText: '最新时间',
    customerOrder: 0, //切换状态
    customerList: [], //客户列表
    keyword: "", //搜索词
    total: 0,
    pageIndex: 1,//分页页码
    pageSize: 6,//一页显示几个数据
    loadingOpj: {
      more: true, //是否有下一页
      loadingText: '',
      isLoading: false
    },
    typeFlag: ""
  },

  /**
   * 生命周期函数--监听页面加载
   */
  onLoad: function (options) {
    this.data.typeFlag = options.type;
    this.getCustomerList('');
  },

  //获取客户列表
  getCustomerList: function (keyword) {
    let self = this,
      userId = getApp().globalData.userInfo.data[0].user_uuid,
      session_id = getApp().globalData.userInfo.session_id;
    wx.showNavigationBarLoading();
    self.setData({
      loadingOpj: {
        isLoading: true,
        loadingText: "玩命加载中..."
      }
    });
    activityService.getCustomerList({
      "session_id": session_id,
      "pageIndex": self.data.pageIndex,
      "pageSize": self.data.pageSize,
      "keyword": keyword
    }, (err, res) => {
      wx.hideNavigationBarLoading();
      wx.stopPullDownRefresh();
      wx.hideLoading();
      if (res.status == 0) {
        self.data.loadingOpj.isLoading = false;
        self.data.total = res.data.total;
        if (self.data.pageIndex === 1) {
          self.data.customerList = [];
        };
        res.data.list.forEach(function (item, index) {
         item.flag = 2
        })
        for (let i = 0; i < res.data.list.length; i++) {
          self.data.customerList.push(res.data.list[i]);
        }
        self.data.loadingOpj.more = self.data.pageIndex * self.data.pageSize < self.data.total ? 1 : 0;
        self.data.loadingOpj.loadingText = self.data.total > 0 ? (self.data.pageIndex * self.data.pageSize < self.data.total ? '' : '已经到底部了') : '';
        self.setData({
          customerList: self.data.customerList
        })
      } else {
        self.data.loadingOpj.loadingText = '';
        wx.showToast({
          title: "获取客户数据失败",
          icon: 'none',
          duration: 2000
        });
      }
      self.setData({
        loadingOpj: self.data.loadingOpj
      });
    });
  },

  //切换排序
  customerAction: function (e) {
    let self = this;
    wx.showActionSheet({
      itemList: self.data.customerActionList,
      success(res) {
        self.setData({
          customerOrder: res.tapIndex
        })
        if (res.tapIndex === 0) {
          self.setData({
            customerActionText: self.data.customerActionList[0],
          })
        } else {
          self.setData({
            customerActionText: self.data.customerActionList[1]
          })
        }
      }
    })
  },

  //搜索客户
  getKeyword: function (e) {
    this.keyword = e.detail.value;
    this.getCustomerList(this.keyword)
  },

  /**
   * 生命周期函数--监听页面显示
   */
  onShow: function () {

  },

  /**
  * 页面相关事件处理函数--监听用户下拉动作
  */
  onPullDownRefresh: function () {
    this.data.pageIndex = 1;
    this.getCustomerList();
  },

  /**
   * 页面上拉触底事件的处理函数
   */
  onReachBottom: function () {
    if (!!this.data.loadingOpj.more) {
      this.data.pageIndex++;
      this.getCustomerList();
    }
  }
})