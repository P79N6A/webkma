const
  activityService = require('../../services/activity-service.js'),
  statisticsService = require('../../services/statistics-service.js'),
  utils = require('../../utils/util.js')

let app = getApp()
let self;
Page({

  /**
   * 页面的初始数据
   */
  data: {
    showLoadMore:false,
    textinfo: '玩命加载中...',
    goodsListData:[],
    statistical: {
      total: '', //报名人数/订单总数/红包领取人数/点赞总数/投票总人数/中奖总人数/拨号插件的点击数
      value: '', //任务浏览客户数/商品详情浏览数
      totalVolume:'' // 成交金额/红包发放总额 
    },
    orderDataSource: {
      total: '',
      value: '',
      totalVolume: ''
    },
    showTitle:false,
    id: "",
    articleid: "",
    activeNavTab: "baseData",
    pageSize: 20,
    params:{
      search:'',
      pageSize:8,
      pageIndex:1
    },
    titleCont:{
      title:'领取人数',
      titleNun: 0,
      redEnvelopes:'发放总额',
      redPrice: 0,
      content:"小小红包，也是一种很好的裂变方式，帮助您带来更多的客户"
    },
    dataList: [{
        key: "share",
        title: "分享数",
        total: 0
      }, {
        key: "visitor",
        title: "访客数",
        total: 0
      }, {
        key: "access",
        title: "访问数",
        total: 0
      }],
    avgLifeTime: "", // 平均访问时长
    areaTopList: "", // 访问地区TOP排名
    pageStatus: "loading",
    plugPageStatus: "loading",
    tabNav:[],
    activePlugTab: "", //当前项
    listData: [], //投票记录
    bgcolor: "",
    fromLables:[],
    conditionTxt:'',
    controlIdFrom:'',
    formDataListData:[],//报名数据列表
    formDataTitle: [],//报名数据title
    redpacketListdata:[],//红包列表数据
    rewardDataList:[],//中奖列表
    isShowInfo:false,
    maskInfoData:{}
  },

  /**
   * 生命周期函数--监听页面加载
   */
  onLoad: function (options) {
    self = this;
    var bg = self.bgColor();
    self.setData({
      id: options.id,
      articleid: options.articleid,
      bgcolor: bg
    });
    console.log("参数", options)
    Promise.all([
      new Promise((resolve, reject) => {
        // 获取表单列表
        activityService.getFormList({
          id: self.data.id
        }, (err, res) => {
          if (err) {
            self.setData({                                                                                                              
              formPageStatus: "error-network"
            });
            return reject(err);
          }
          if (res.status != 0) {
            self.setData({
              formPageStatus: "error-data"
            });
            return reject(res.message);
          }
          self.setData({
            formPageStatus: res.data.length == 0 ? "empty" : "",
            formList: res.data.map((item, index) => {
              return {
                controlId: item.controlId,
                name: item.name,
                total: item.total,
                todayTotal: item.todayTotal,
                _open: false,
                detail: {
                  _isLoading: false
                }
              }
            })
          });
          resolve();
        });
      }),
      new Promise((resolve, reject) => {
        //获取获取活动 - 统计现状
        statisticsService.aggsTypeByBelongModule({
          as_belong_module: [self.data.id]
        }, (err, res) => {
          if (err) return reject(err);
          if (res.status != 0) return reject(res.message);
          self.data.dataList.forEach(item => {
            item.total = res.data.group[0]["scan_" + item.key];
          });
          self.data.areaTopList = res.data.area_top_list.slice(0, 5).join("、");
          self.data.avgLifeTime = ((time) => {
            if (!time) return "";
            if (time < 60) return `${time}秒`;
            return `${Math.floor(time / 60)}分${Math.floor(time % 60)}秒`;
          })(res.data.avg_life_time);
          self.setData(self.data);
          resolve();
        });
      })
    ]).then(results => {
      self.setData({
        pageStatus: ""
      });
    }).catch(err => {
      self.setData({
        pageStatus: "error-data"
      });
      console.error(err);
    });
  },
  onShow(){
    let that = this
    that.getTabs()
  },
/*------------------------------ 插件数据--------------------------------------*/
  getKeyword(e){
    this.setData({
      'params.search': e.detail.value
    })
  },
    //获取tabs
  getTabs(){
    let self = this
    activityService.plugTabList({
      taskId: self.data.id
    }, (err, res) => {
      if (res.status == 0) {
        let arr = res.data
        if(arr.length>0){
          arr.forEach(item => {
            switch (item.type) {
              case 1:
                item.key = "card"
                break;
              case 2:
                item.key = "formData"
                break;
              case 3:
                item.key = "goods"
                break;
              case 4:
                item.key = "redEnvelopes"
                break;
              case 5:
                item.key = "thumbup"
                break;
              case 6:
                item.key = "vote"
                break;
              case 7:
                item.key = "reward"
                break;
              default:
                item.key = "call"
            }
          })
        }
        self.setData({
          tabNav: arr,
          activePlugTab:arr[0]?arr[0].key:''
        })
        self.navPlurTabChange()
        if (arr[0].type==2){
          self.getIds()
        }
      }
    })
  },
    // 获取 controlId 
  getIds(){
    let self = this
    let cont = {
      relationId: self.data.id
    }
    activityService.fromLableList(cont, (err, res) => {
      let arr = res.data ? res.data : []
      console.log(res.data)
      self.setData({
        fromLables: arr,
        conditionTxt: arr[0].name,
        controlIdFrom: arr[0].controlId
      })
    })
  },
  // 修改表单
  openConditionlist(e) {
    let self = this
    let lablesArr = self.data.fromLables
    console.log(lablesArr)
    let listArr = [] 
    lablesArr.forEach(item=>{
      listArr.push(item.name)
    })
    console.log(listArr)
    wx.showActionSheet({
      itemList:listArr,
      success(res) {
        console.log(res)
        self.setData({
          controlIdFrom: lablesArr[res.tapIndex].controlId,
          conditionTxt: lablesArr[res.tapIndex].name
        })
        self.getFormContData()
      }
    })
  },
  // 投票
  getVoteList() {
    let self = this
    let cont = {
      relationId: self.data.id
    }
    activityService.voteList(cont, (err, res) => {
      let arr = res.data.list ? res.data.list : []
      self.setData({
        listData: self.data.params.pageIndex == 1 ? arr : self.data.listData.concat(arr)
      })
    })
  },
    //公共汇总数据 pluginStatistical
    getStatisitical(type){
      let self = this
      let contType = 2  //1：名片(预留) 2：报名 3：商品 4：红包 5：点赞 6：投票 7：中奖 8：拨号
      switch (type) {
        case "formData":
          contType=2
          break;
        case "goods":
          contType = 3
          break;
        case "redEnvelopes":
          contType = 4
          break;
        case "thumbup":
          contType = 5
          // 点赞
          break;
        case "vote":
          contType = 6
          // 投票
          break;
        case "reward":
          contType = 7
          // 中奖
          break;
        default:
          contType = 8
          // 拨号
      }
      return new Promise((resolve,reject)=>{
        activityService.pluginStatistical({
          taskId: self.data.id,
          type: contType
        }, (err, res) => {
          if(res.status==0){
            let cont = self.data.statistical
            cont.total = res.data.dataNum ? res.data.dataNum : 0
            cont.value = res.data.browseData ? res.data.browseData : 0
            cont.totalVolume = res.data.amount ? res.data.amount : 0
            self.setData({
              statistical: cont
            })
            resolve(cont)
          }
        })
      })
    },
    // 报名
  getFormContData(){
    let self = this
    let cont = {
      controlId: self.data.controlIdFrom,
      id: self.data.id
    }
    activityService.getFormContent(cont, (err, resdata) => {
      if(resdata.status==0){
        self.setData({
          formDataListData: resdata.data.list,
          formDataTitle: resdata.data.title
        })
      }
    })
  },
  //报名查看详情
  pulgFromEvent(data){
    // 中奖 data.currentTarget.dataset.maskitem 
    // 报名 data
    let maskData;
    if (this.data.activePlugTab=="formData"){
      maskData = data
    } else if (this.data.activePlugTab == "reward"){
      maskData = data.currentTarget.dataset.maskitem
    }
    this.setData({
      isShowInfo:true,
      maskInfoData:maskData
    })
  },
  // 复制信息 copyMaskInfo 
  copyMaskInfo(){
    let copydata = ''
    if (this.data.activePlugTab == "formData") {
      let infoTitle = this.data.formDataTitle
      let infoData = this.data.maskInfoData.detail.content
      infoTitle.forEach((item,index)=>{
        if(index>0){
          copydata += item + ': ' + infoData[index - 1].text+' '
        }
      })
    } else if (this.data.activePlugTab == "reward") {
      let infodata = this.data.maskInfoData
      copydata += "活动名称：" + infodata.prizeName 
      copydata += " 奖项奖品：" + infodata.prizeName 
      copydata += " 兑奖情况：" 
      copydata += infodata.userCashType == 1 ? '线上兑奖 ' : '线下兑奖 ' 
      copydata += infodata.exchangeState == 1 ? '奖品已寄出 ' : '未兑奖 '
      copydata += infodata.exchangetime ? infodata.exchangetime:"" 
      copydata += " "
      infodata.content.forEach(item=>{
        copydata += item.name + ": " + item.content
      })
    }
    wx.setClipboardData({
      data: copydata,
      success(res) {
        wx.getClipboardData({
          success(res) {
            console.log(res.data)
          }
        })
      }
    })
  },
    //商品列表
    getGoodsList(){
      let self = this 
      let cont = {
        "businessId": app.globalData.userInfo.businessId,
        "taskId": self.data.id,
        "goodsName": self.data.params.search,
        "pageIndex": self.data.params.pageIndex,
        "pageSize": self.data.params.pageSize
      }
      activityService.plugUnitGoodsList(cont, (err, res) => {
        let arr = res.data.goods ? res.data.goods : []
        self.setData({
          goodsListData: self.data.params.pageIndex == 1 ? arr : self.data.listData.concat(arr)
        })
      })
    },
    //商品概况
    getGoodsCont(){
      let self = this
      let cont = {
        "businessId": app.globalData.userInfo.businessId,
        "taskId": self.data.id
      }
      activityService.plugUnitGoodsSummary(cont, (err, res) => {
        self.setData({
          "orderDataSource.total": res.data.totalBrowseCount,
          "orderDataSource.value": res.data.totalOrderCount, 
          "orderDataSource.totalVolume": res.data.totalVolume
        })
      })
    },
    //红包
  getRedPacketList() {
    let self = this
    let cont = {
      taskId: self.data.id,
      pageIndex: self.data.params.pageIndex,
      pageSize: self.data.params.pageSize,
      keyword: self.data.params.search
    }
    activityService.redRedpacketlist(cont, (err, res) => {
      let arr = res.data.list ? res.data.list : []
      self.setData({
        redpacketListdata: self.data.params.pageIndex == 1 ? arr : self.data.redpacketListdata.concat(arr)
      })
    })
  },
    // 中奖
  getRewardContent(){
    let self = this
    let cont = {
      relationId: self.data.id,
      pageSize: self.data.params.pageSize,
      pageIndex: self.data.params.pageIndex
    }
    activityService.drawprizeLog(cont,(err,res)=>{
      let arr = res.data.list ? res.data.list:[]
      self.setData({
        rewardDataList: self.data.params.pageIndex == 1 ? arr : self.data.rewardDataList.concat(arr)
      })
    })
  },
    // 搜索
  getInfoCont(){
    let that = this
    this.navPlurTabChange()
  },
  closeMask(){
    this.setData({
      isShowInfo:false
    })
  },
  navbarTabChange: function (e) { //一级菜单tab切换
    this.setData({
      activeNavTab: e.detail.key,
      activePlugTab: this.data.tabNav[0].key
    })
    this.navPlurTabChange()
    if (this.data.activeNavTab[0].key == 'formData'){
      this.getFormContData()
    }
  },
  navPlurTabChange: function (e) { //插件tab切换
    let that = this
    let isKey = that.data.activePlugTab
    if (e) {
      isKey = e.currentTarget.dataset.key
      if (isKey != that.data.activePlugTab ){
        that.setData({
          activePlugTab: isKey,
          "params.pageIndex": 1
        })
      }
    }
    that.getStatisitical(isKey).then(res=>{
      switch (that.data.activePlugTab) {
        case "formData":
          // 报名
          that.setData({
            showTitle: isKey == 'formData' || isKey == 'goods' ? false : true,
            showLoadMore: false
          })
          that.getFormContData()
          break;
        case "goods":
          // 商品
          that.setData({
            showTitle: isKey == 'formData' || isKey == 'goods' ? false : true,
            showLoadMore: false
          })
          that.getGoodsList()
          that.getGoodsCont()
          break;
        case "redEnvelopes":
          // 红包
          that.setData({
            "titleCont.title": '领取人数',
            "titleCont.titleNun": res.total,
            "titleCont.redEnvelopes": '发放总额',
            "titleCont.redPrice": res.totalVolume,
            "titleCont.content": "小小红包，也是一种很好的裂变方式，帮助您带来更多的客户",
            showTitle: isKey == 'formData' || isKey == 'goods' ? false : true,
            showLoadMore: false
          })
          that.getRedPacketList()
          break;
        case "thumbup":
          that.setData({
            "titleCont.title": '点赞人数',
            "titleCont.titleNun": res.total,
            "titleCont.content": "小小点赞是客户对您的最好褒奖",
            showTitle: isKey == 'formData' || isKey == 'goods' ? false : true,
            showLoadMore: false
          })
          // 点赞
          break;
        case "vote":
          // 投票
          that.setData({
            "titleCont.title": '投票人数',
            "titleCont.titleNun": res.total,
            "titleCont.content": "小小投票，是客户表达自己心意的方式，也是对您的信任",
            showTitle: isKey == 'formData' || isKey == 'goods' ? false : true,
            showLoadMore: false
          })
          that.getVoteList()
          break;
        case "reward":
          // 中奖
          that.setData({
            "titleCont.title": '中奖人数',
            "titleCont.titleNun": res.total,
            "titleCont.content": "抽奖活动，增加客户和你的黏性，帮助他更好的认识你",
            showTitle: isKey == 'formData' || isKey == 'goods' ? false : true,
            showLoadMore: false
          })
          that.getRewardContent()
          break;
        default:
          // 拨号
          that.setData({
            "titleCont.title": '拨号人数',
            "titleCont.titleNun": res.total,
            "titleCont.content": "小小拨号，证明客户是有心想要联系你，还等什么，主动出击吧！",
            showTitle: isKey == 'formData' || isKey == 'goods' ? false : true,
            showLoadMore: false
          })
      }
      var list = this.data.tabNav;
    })
    // for (var i in list) {
    //   console.log("lis",list[i].key)
    // }
    // switch (e.detail.key) {
    //   case "formData":
    //     self.getFormContData();
    //     break;
    // }
  },
  /**
   * 页面相关事件处理函数--监听用户下拉动作
   */
  onPullDownRefresh: function () {
    this.setData({
      "params.pageIndex": 1
    })
    this.getList()
  },
  /**
   * 页面监听滚动条
   */
  onPageScroll(e) {
    let that = this
    this.setData({
      showLoadMore: that.data.activeNavTab == 'plugData'? true : false
    })
  },

  /**
   * 页面上拉触底事件的处理函数
   */
  onReachBottom: function () {
    let that = this
    let pageAll = Math.ceil(that.data.total / that.data.params.pageSize)
    that.setData({
      "params.pageIndex": that.data.params.pageIndex+1
    })
    if (that.data.params.pageIndex <= pageAll) {
      that.navPlurTabChange()
    } else {
      that.setData({
        textinfo: "已经到底了"
      })
    }
  },
/*------------------------------插件数据结束--------------------------------------*/
  /**
   * 用户点击右上角分享
   */
  onShareAppMessage: function () {

  },

  previewImage: function (e) {
    let urls = e.currentTarget.dataset.imgs.map(item => {
      return item.img
    });
    wx.previewImage({
      current: urls[e.currentTarget.id],
      urls: urls
    });
  },
  stopScroll: function (event) {
    event && event.stopPropagation && event.stopPropagation();
  },
  bgColor: function(){
    var i = 0;
    var str = "#";
    var random = 0;
    var aryNum = ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "A", "B", "C", "D", "E", "F"];

    for (i = 0; i < 6; i++) {
      random = parseInt(Math.random() * 16);

      str += aryNum[random];
    }
    return str
  } 
})